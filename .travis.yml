jobs:
  include:
    - os: windows
      language: shell
      env: JAVA_HOME="$HOME/.sdkman/candidates/java/current"


before_install:
  - choco install zip unzip
  - choco install visualstudio2017-workload-vctools
  
  - curl -sL https://get.sdkman.io | bash
  - mkdir -p "$HOME/.sdkman/etc/"
  - echo sdkman_auto_answer=true > "$HOME/.sdkman/etc/config"
  - echo sdkman_auto_selfupdate=true >> "$HOME/.sdkman/etc/config"
  - "source $HOME/.sdkman/bin/sdkman-init.sh"

install:
  - sdk install java 20.0.0.r11-grl
  - gu.cmd install native-image
  - native-image.cmd --version
  - sdk install maven

script:
  - (chmod +x ./bash/semver.sh) || true
  - (. ./bash/semver.sh) || true
  - mvn install -Dmaven.skip.deploy=true -Drevision=$SEMVER_LAST_TAG -DbuildNumer=$TRAVIS_BUILD_NUMBER
  - export project_version=$(mvn help:evaluate -N -Dexpression=project.version|grep -v '\[')
  - find target -iname "*dependencies.jar" -exec mv {} ./keecli-$project_version.jar  \;
  - ./buildnative.bat ./keecli-$project_version.jar ./keecli
  - cp /c/Windows/System32/VCRUNTIME140.dll .
  - zip keecli-$project_version.zip keecli.exe VCRUNTIME140.dll

deploy:
  provider: releases
  api_key: $GITHUB_TOKEN
  file:
    - keecli-$project_version.zip
    - keecli-$project_version.jar
  skip_cleanup: true
  on:
    branch: master
    tags: true